<!DOCTYPE html>
<html lang="es" data-theme="cupcake">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con Socket.io</title>
    <link href="/public/output.css" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="h-screen">

    <div class="drawer lg:drawer-open">
        <input id="my-drawer-2" type="checkbox" class="drawer-toggle" />

        <!-- Contenido de la página (Chat) -->
        <div class="drawer-content flex flex-col h-screen">
            <header class="bg-zinc-50/50 p-7 flex items-center gap-4">
                <!-- Botón para abrir/cerrar el drawer en pantallas pequeñas -->
                <label for="my-drawer-2" class="btn btn-primary drawer-button lg:hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </label>
                <h1 class="text-3xl font-thin text-center flex-1 text-sky-500" id="chat-title">PhamtomChat</h1>
            </header>

            <main id="messages" class="flex-1 p-4 overflow-y-auto bg-zinc-50/50 justify-items-center align-ed content-end">
                <div id="chat-bubble"></div>
            </main>

            <footer class="bg-zinc-50/50 p-4 flex justify-center">
                <div id="form" class="grid-of-inputs border-zinc-300">
                    <input id="input-message" autocomplete="off" class="placeholder:text-base/10 text-base" placeholder="Escribe un mensaje..." />
                    <label for="submit" class="label-send">
                        <div class="btn-send" id="btn-send" aria-label="send message">
                            <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="send-icon" class="icon glyph" fill="#0ea5e9" width="24" height="24" stroke="#000000" stroke-width="0.00024000000000000003"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"><path d="M21.88,4.73,16.2,20.65A2,2,0,0,1,14.3,22h0a2,2,0,0,1-1.9-1.31l-2.12-5.52,1.54-1.54,2.49-2.49a1,1,0,1,0-1.42-1.42l-2.49,2.49L8.82,13.76,3.31,11.63a2,2,0,0,1,0-3.83L19.27,2.12a2,2,0,0,1,2.61,2.61Z" style="fill:#0ea5e9"></path></g></svg>
                        </div>
                    </label>
                    <input placeholder="submit" id="submit" class="hidden">
                </div>
            </footer>
        </div>

        <!-- Contenido del Sidebar -->
        <div class="drawer-side bg-zinc-100/95">
            <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
            <div id="sidebar-container" class="w-80 min-h-full rounded-br-2xl lg:rounded-br-none">
                <!-- El contenido de sidebar.html se cargará aquí -->
            </div>
        </div>
    </div>

    <script type="module">
        import { loadComponent } from '/src/lib/Load.js';
        import { openChat, CreateChatBubble, renderChatHistory, verifyIfChatIsOpen, notificateMessage } from '/src/lib/Messages.js';
 
        document.addEventListener('DOMContentLoaded', async() => {
            await loadComponent('sidebar-container', '/src/components/sidebar.html');
            await loadComponent('chat-bubble', '/src/components/chat.html');
            // document.getElementById('general-chat').addEventListener('click', (e) => openChat(null, null, 'General'));
        });
 
        // --- Lógica del chat ---
        const socket = io();
        const form = document.getElementById('form');
        const input = document.getElementById('input-message');
        const messages = document.getElementById('messages');
        let session = { id: '', username: '' };
 
        //aqui solo se recibe el id y username del usuario actual
        socket.on('session', (data) => {
            session = data;
        });
        
        //recibe la lista de usuarios conectados al cliente y crea la lista en el sidebar
        socket.on('users updated', (users) => {
            const userList = document.getElementById('user-list');
            if (!userList) return;
 
            userList.innerHTML = '';
            // Limpiar lista anterior
            users.forEach(user => {
                if (user.id !== session.id) { // No mostrar el usuario actual en la lista
                    const notification = document.createElement('span');
                    notification.id = `${user.id}-notification`;
                    notification.style.display = 'none';
                    const usernameText = document.createElement('a');
                    const userItem = document.createElement('li');
                    usernameText.style.width = '100%';
                    userItem.style.width = '80%';
                    userItem.id = `item-${user.id}`;
                    userItem.style.flexDirection = 'row';
                    userItem.style.flexWrap = 'nowrap';
                    userItem.style.borderRadius = '10px';

                    // notification.innerText = '●';
                    usernameText.innerText = user.username;
                    userItem.appendChild(usernameText);
                    userItem.appendChild(notification);
                    userList.appendChild(userItem);

                    // userItem.innerHTML = `<a>${user.username}</a>`;
                    // userItem.id = user.id;
                    // userList.appendChild(userItem);
                    userItem.onclick = (e) => openChat(user, socket, 'User');
                }
            });
        });
        
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = '';
            }
        });
        
        socket.on('chat history', (history) => {
            renderChatHistory(history, socket.id);
        });
        //Escucha los mensajes entrantes y los muestra en el chat si esta abierto
        socket.on('chat_message', (data) => {
            const { id, user, message } = data;
            const isChatOpen = verifyIfChatIsOpen(id);
            isChatOpen ? CreateChatBubble(message, session.id === id) : notificateMessage(id);
        });
    </script>
 
</body>
</html>